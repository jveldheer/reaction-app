<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reaction Drill</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    #landing, #app {
      display: none;
    }
    #landing.active, #app.active {
      display: block;
    }
    input, button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 10px;
    }
    #countdown {
      font-size: 3em;
      margin-top: 20px;
    }
    img.logo {
      max-width: 200px;
      height: auto;
      margin-bottom: 15px;
    }
    .primary-button {
      background-color: black;
      color: white;
      border: none;
      font-size: 1.2em;
      padding: 15px 30px;
      cursor: pointer;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <!-- Landing Page -->
  <div id="landing" class="active">
    <img src="vlvl16x9.png" alt="VLVL Logo" class="logo" />
    <h2>Enter the Reaction Timer App</h2>
    <button class="primary-button" id="enterAppBtn">Enter the Reaction Timer App</button>
  </div>

  <!-- Main App -->
  <div id="app">
    <img src="vlvl16x9.png" alt="VLVL Logo" class="logo" />
    <h1>Reaction Drill</h1>
    <label for="duration">Training Duration (seconds):</label>
    <input type="number" id="duration" min="1" />
    <button id="startButton" class="primary-button">Start Drill</button>
    <div id="countdown"></div>
  </div>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    function beep(duration = 200, frequency = 1000, volume = 1, type = "sine") {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.value = frequency;
      oscillator.type = type;
      gainNode.gain.value = volume;
      oscillator.start();
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    function playClap() {
      const ctx = audioContext;
      const bufferDuration = 0.2;
      const bufferSize = ctx.sampleRate * bufferDuration;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      const noiseSource = ctx.createBufferSource();
      noiseSource.buffer = buffer;

      const gainNode = ctx.createGain();
      gainNode.gain.setValueAtTime(1, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + bufferDuration);

      noiseSource.connect(gainNode);
      gainNode.connect(ctx.destination);
      noiseSource.start();
    }

    function playBuzzer() {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(250, audioContext.currentTime);
      oscillator.type = "square";
      gainNode.gain.setValueAtTime(1, audioContext.currentTime);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.8);
    }

    function scheduleClap(endTime) {
      if (Date.now() < endTime - 500) {
        const randomDelay = Math.random() * 2500 + 500;
        setTimeout(() => {
          if (Date.now() < endTime - 200) {
            playClap();
            scheduleClap(endTime);
          }
        }, randomDelay);
      }
    }

    document.getElementById("enterAppBtn").addEventListener("click", () => {
      audioContext.resume().then(() => {
        beep(); // test beep to confirm unlock
        document.getElementById("landing").classList.remove("active");
        document.getElementById("app").classList.add("active");
      });
    });

    document.getElementById("startButton").addEventListener("click", () => {
      const durationInput = document.getElementById("duration");
      const totalDuration = parseInt(durationInput.value) * 1000;
      if (isNaN(totalDuration) || totalDuration <= 0) {
        alert("Please enter a valid duration in seconds.");
        return;
      }

      durationInput.disabled = true;
      document.getElementById("startButton").disabled = true;
      const countdownElement = document.getElementById("countdown");
      let count = 3;

      function countdown() {
        if (count > 0) {
          countdownElement.innerText = count;
          beep();
          count--;
          setTimeout(countdown, 1000);
        } else {
          countdownElement.innerText = "Go!";
          playClap();
          setTimeout(() => {
            const drillEndTime = Date.now() + totalDuration;
            scheduleClap(drillEndTime);
            countdownElement.innerText = "";
            setTimeout(() => {
              playBuzzer();
              durationInput.disabled = false;
              document.getElementById("startButton").disabled = false;
            }, totalDuration);
          }, 300);
        }
      }

      countdown();
    });
  </script>
</body>
</html>
