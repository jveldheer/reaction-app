<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audible Reaction Timers</title>
<style>
  :root { --btn:#000; --btnTxt:#fff; --warn:#ff4444; }
  *     { box-sizing:border-box; }
  body  { font-family:sans-serif; text-align:center; padding:20px; margin:0; }
  section      { display:none; }
  section.show { display:block; }
  img.logo     { max-width:200px; margin-bottom:15px; }
  button,input { font-size:1.05em; padding:12px 22px; margin:8px; border:none; border-radius:6px; }
  .primary     { background:var(--btn); color:var(--btnTxt); cursor:pointer; }
  #duration    { border:2px solid #000; width:140px; text-align:center; }
  #countdown   { font-size:3em; margin-top:20px; }
  #ringerBar   {position:fixed;left:0;bottom:0;width:100%;background:var(--warn);color:#fff;
                font-weight:bold;padding:10px 6px;z-index:999;}
</style>
</head>
<body>

<!-- Landing -->
<section id="landing" class="show">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h2>Select a Timer</h2>
  <button class="primary modeBtn" data-mode="clap">Audible Clap Timer</button><br>
  <button class="primary modeBtn" data-mode="number">Audible Number Timer</button><br>
  <button class="primary modeBtn" data-mode="direction">Audible Direction Timer</button>
</section>

<!-- Timer -->
<section id="timer">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h1 id="timerTitle"></h1>
  <label>Training Duration (seconds)</label><br>
  <input type="number" id="duration" min="1" /><br>
  <button id="startBtn" class="primary">Start Drill</button>
  <div id="countdown"></div>
  <button id="backBtn" class="primary" style="margin-top:28px;">‚Üê Back</button>
</section>

<div id="ringerBar">üîà Make sure your device's Ringer is set to ON</div>

<script>
/* ---------- Basic refs ---------- */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const synth    = window.speechSynthesis;

let voicesReady = false;
synth.onvoiceschanged = ()=> { voicesReady = true; };

const landing   = document.getElementById('landing');
const timerPage = document.getElementById('timer');
const titleEl   = document.getElementById('timerTitle');
const durInput  = document.getElementById('duration');
const startBtn  = document.getElementById('startBtn');
const backBtn   = document.getElementById('backBtn');
const countEl   = document.getElementById('countdown');

let mode = '';          // clap | number | direction
let prevValue = null;   // last spoken value
let stopFlag  = false;  // for cleanup on back

/* ---------- Helpers ---------- */
const show  = el => el.classList.add('show');
const hide  = el => el.classList.remove('show');

function tone(f=1000, d=200, type='sine'){
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=f;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(1,audioCtx.currentTime);
  o.start(); o.stop(audioCtx.currentTime+d/1000);
}

function clap(){
  const len=audioCtx.sampleRate*0.14; // 140 ms
  const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*(1-i/len);
  const src=audioCtx.createBufferSource();
  src.buffer=buf; src.connect(audioCtx.destination); src.start();
}

/* robust English speech */
function speak(text){
  const doSpeak = () =>{
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang='en-US'; utter.volume=1; utter.rate=1; utter.pitch=1;
    synth.cancel(); synth.speak(utter);
  };
  if(voicesReady){ doSpeak(); }
  else{ synth.onvoiceschanged = ()=>{ voicesReady=true; doSpeak(); }; }
}

/* ---------- Landing mode buttons ---------- */
document.querySelectorAll('.modeBtn').forEach(btn=>{
  btn.onclick = () =>{
    mode = btn.dataset.mode;
    titleEl.textContent = {
      clap:'Audible Clap Timer',
      number:'Audible Number Timer',
      direction:'Audible Direction Timer'
    }[mode];
    durInput.value=''; prevValue=null; countEl.textContent='';
    hide(landing); show(timerPage);
  };
});

/* ---------- Back ---------- */
backBtn.onclick = ()=>{
  stopFlag = true;                 // stop any running schedule
  hide(timerPage); show(landing);
};

/* ---------- Main drill ---------- */
startBtn.onclick = ()=>{
  const totalMs = parseInt(durInput.value)*1000;
  if(isNaN(totalMs)||totalMs<=0){ alert('Enter a valid time'); return; }

  audioCtx.resume().then(()=>{
    durInput.disabled = true;
    startBtn.disabled = true;
    backBtn.disabled  = true;
    stopFlag          = false;

    let c = 3;
    const finish = () =>{
      tone(250,800,'square');
      durInput.disabled=false;
      startBtn.disabled=false;
      backBtn.disabled=false;
      countEl.textContent='';
    };

    const afterCountdown = () =>{
      if(stopFlag) return;
      countEl.textContent='Go!';
      trigger(); // first event

      const endTime = Date.now()+totalMs;
      schedule(endTime);
      setTimeout(()=>!stopFlag && finish(), totalMs);
    };

    const tick = () =>{
      if(stopFlag) return;
      if(c>0){ countEl.textContent=c; tone(); c--; setTimeout(tick,1000); }
      else   { afterCountdown(); }
    };
    tick();
  });

  /* schedule recurring prompts until endTime */
  function schedule(endTime){
    if(stopFlag) return;
    const delay = Math.random()*1500+500; // 0.5-2 s
    if(Date.now()+delay >= endTime-200) return; // quit near end
    setTimeout(()=>{
      if(!stopFlag){ trigger(); schedule(endTime); }
    }, delay);
  }

  function trigger(){
    if(mode==='clap'){ clap(); return; }

    if(mode==='number'){
      let n;
      do n = Math.floor(Math.random()*5)+1; while(n===prevValue);
      prevValue = n; speak(String(n));
    }else if(mode==='direction'){
      const dirs=['right','left','back','forward']; let d;
      do d = dirs[Math.floor(Math.random()*dirs.length)]; while(d===prevValue);
      prevValue = d; speak(d);
    }
  }
};
</script>
</body>
</html>
