<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audible Reaction Timers</title>
<style>
  :root { --btn:#000; --btnText:#fff; --warn:#ff4444; }
  body  { font-family:sans-serif; text-align:center; padding:20px; }
  section      { display:none; }
  section.show { display:block; }
  img.logo     { max-width:200px; margin-bottom:15px; }
  button,input { font-size:1.1em; padding:12px 22px; margin:8px; border:none; border-radius:5px; }
  .primary     { background:var(--btn); color:var(--btnText); cursor:pointer; }
  #duration    { border:2px solid #000; width:140px; text-align:center; }
  #countdown   { font-size:3em; margin-top:20px; }
  #ringerBar   {position:fixed;bottom:0;left:0;width:100%;background:var(--warn);color:#fff;font-weight:bold;
                padding:10px;z-index:999;}
</style>
</head>
<body>

<!-- Landing -->
<section id="landing" class="show">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h2>Select a Timer</h2>
  <button class="primary" data-mode="clap">Audible Clap Timer</button><br>
  <button class="primary" data-mode="number">Audible Number Timer</button><br>
  <button class="primary" data-mode="direction">Audible Direction Timer</button>
</section>

<!-- Timer Page -->
<section id="timer">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h1 id="timerTitle"></h1>
  <label>Training Duration (seconds):</label><br>
  <input type="number" id="duration" min="1"><br>
  <button id="startBtn" class="primary">Start Drill</button>
  <div id="countdown"></div>
  <button id="backBtn" class="primary" style="margin-top:25px;">‚Üê Back</button>
</section>

<!-- Ringer reminder -->
<div id="ringerBar">üîà Make sure your device's Ringer is set to ON</div>

<script>
/* ------- basic refs ------- */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const synth    = window.speechSynthesis;
let defaultVoice=null;

const landing  = document.getElementById('landing');
const timerSec = document.getElementById('timer');
const titleEl  = document.getElementById('timerTitle');
const durEl    = document.getElementById('duration');
const startBtn = document.getElementById('startBtn');
const backBtn  = document.getElementById('backBtn');
const countEl  = document.getElementById('countdown');

let mode='', lastVal=null;

/* ------- helpers ------- */
function show(el){ el.classList.add('show'); }
function hide(el){ el.classList.remove('show'); }

function playTone(freq=1000,dur=200,type='sine'){
  const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
  osc.connect(g); g.connect(audioCtx.destination);
  osc.type=type; osc.frequency.value=freq;
  g.gain.setValueAtTime(1,audioCtx.currentTime);
  osc.start(); osc.stop(audioCtx.currentTime+dur/1000);
}

/* real clap via white-noise burst */
function playClap(){
  const len=audioCtx.sampleRate*0.15;                    // 150 ms
  const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/len,2);
  const src=audioCtx.createBufferSource(); src.buffer=buf;
  src.connect(audioCtx.destination); src.start();
}

function speak(text){
  if(!defaultVoice){ // pick a usable voice once
    defaultVoice = synth.getVoices().find(v=>/en/i.test(v.lang)) || null;
  }
  synth.cancel();                      // stop any earlier utterance
  const u=new SpeechSynthesisUtterance(text);
  if(defaultVoice) u.voice=defaultVoice;
  u.rate=1; u.pitch=1;
  synth.speak(u);
}

/* ------- landing buttons ------- */
landing.querySelectorAll('button[data-mode]').forEach(btn=>{
  btn.onclick=()=>{
    mode=btn.dataset.mode;
    titleEl.textContent={
      clap:'Audible Clap Timer',
      number:'Audible Number Timer',
      direction:'Audible Direction Timer'
    }[mode];
    durEl.value=''; countEl.textContent='';
    hide(landing); show(timerSec);
  };
});

/* ------- back ------- */
backBtn.onclick=()=>{ hide(timerSec); show(landing); };

/* ------- main drill ------- */
startBtn.onclick=()=>{
  audioCtx.resume().then(()=>{
    const totalMs=parseInt(durEl.value)*1000;
    if(isNaN(totalMs)||totalMs<=0){ alert('Enter a valid time'); return; }
    durEl.disabled=true; startBtn.disabled=true; backBtn.disabled=true;
    let cnt=3; const endBeep=()=>playTone(250,800,'square');

    function stepCountdown(){
      if(cnt>0){ countEl.textContent=cnt; playTone(); cnt--; setTimeout(stepCountdown,1000);}
      else{
        countEl.textContent='Go!';
        if(mode==='clap') playClap(); else triggerPrompt();
        const stopT=Date.now()+totalMs; schedule(stopT);
        setTimeout(()=>{ endBeep();
          durEl.disabled=false;startBtn.disabled=false;backBtn.disabled=false;countEl.textContent='';
        },totalMs);
      }
    }
    function schedule(endTime){
      if(Date.now()<endTime-400){
        const delay=Math.random()*1500+500;
        setTimeout(()=>{
          if(Date.now()<endTime-200){
            if(mode==='clap') playClap(); else triggerPrompt();
            schedule(endTime);
          }
        },delay);
      }
    }
    function triggerPrompt(){
      if(mode==='number'){
        let n; do{ n=Math.floor(Math.random()*5)+1;}while(n===lastVal);
        lastVal=n; speak(String(n));
      }else if(mode==='direction'){
        const dirs=['right','left','back','forward']; let d;
        do{ d=dirs[Math.floor(Math.random()*dirs.length)]; }while(d===lastVal);
        lastVal=d; speak(d);
      }
    }
    stepCountdown();
  });
};
</script>
</body>
</html>
