<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Audible Reaction Timers</title>
<style>
  :root { --btn:#000; --btnText:#fff; --warn:#ff4444; }
  body  { font-family:sans-serif; text-align:center; padding:20px; }
  section      { display:none; }
  section.show { display:block; }
  img.logo     { max-width:200px; margin-bottom:15px; }
  button,input { font-size:1.1em; padding:12px 22px; margin:8px; border:none; border-radius:6px; }
  .primary     { background:var(--btn); color:var(--btnText); cursor:pointer; }
  #duration    { border:2px solid #000; width:150px; text-align:center; }
  #countdown   { font-size:3em; margin-top:20px; }
  #ringerBar   { position:fixed; bottom:0; left:0; width:100%; background:var(--warn);
                 color:#fff; font-weight:bold; padding:10px; z-index:999; }
</style>
</head>
<body>

<!-- Landing -->
<section id="landing" class="show">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h2>Select a Timer</h2>
  <button class="primary" data-mode="clap">Audible Clap Timer</button><br>
  <button class="primary" data-mode="number">Audible Number Timer</button><br>
  <button class="primary" data-mode="direction">Audible Direction Timer</button>
</section>

<!-- Timer page -->
<section id="timer">
  <img src="vlvl16x9.png" class="logo" alt="VLVL Logo">
  <h1 id="title"></h1>
  <label>Training Duration (seconds):</label><br>
  <input id="duration" type="number" min="1"><br>
  <button id="startBtn" class="primary">Start Drill</button>
  <div id="countdown"></div>
  <button id="backBtn" class="primary" style="margin-top:25px;">‚Üê Back</button>
</section>

<!-- Ringer reminder -->
<div id="ringerBar">üîà Make sure your device's Ringer is set to ON</div>

<script>
/* --------- constants & refs --------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const synth    = window.speechSynthesis;

const landing   = document.getElementById('landing');
const timerPage = document.getElementById('timer');
const titleEl   = document.getElementById('title');
const durEl     = document.getElementById('duration');
const startBtn  = document.getElementById('startBtn');
const backBtn   = document.getElementById('backBtn');
const countEl   = document.getElementById('countdown');

let mode='', lastVal=null;

/* --------- UI helpers --------- */
const show = el => el.classList.add('show');
const hide = el => el.classList.remove('show');

/* --------- simple audio helpers --------- */
const playTone = (f=1000,d=200,t='sine') =>{
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=t; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(1,audioCtx.currentTime);
  o.start(); o.stop(audioCtx.currentTime+d/1000);
};
const playClap = () =>{
  const len=audioCtx.sampleRate*0.15, buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/len,2);
  const src=audioCtx.createBufferSource(); src.buffer=buf; src.connect(audioCtx.destination); src.start();
};

/* --------- robust speech (EN) --------- */
function speakEN(text){
  const speakNow = ()=>{
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';         // ensure English
    u.volume=1; u.rate=1; u.pitch=1;
    synth.cancel();
    // tiny timeout avoids some Chrome race conditions
    setTimeout(()=>synth.speak(u),0);
  };

  // wait until at least one voice exists (max 2 s)
  if(!synth.getVoices().length){
    let waited=0;
    const iv=setInterval(()=>{
      if(synth.getVoices().length || waited>20){
        clearInterval(iv); speakNow();
      }
      waited++;
    },100); // poll every 100 ms
  } else { speakNow(); }
}

/* --------- landing button handlers --------- */
landing.querySelectorAll('button[data-mode]').forEach(btn=>{
  btn.onclick=()=>{
    mode=btn.dataset.mode;
    titleEl.textContent={
      clap:'Audible Clap Timer',
      number:'Audible Number Timer',
      direction:'Audible Direction Timer'
    }[mode];
    durEl.value=''; lastVal=null; countEl.textContent='';
    hide(landing); show(timerPage);
  };
});

/* back */
backBtn.onclick=()=>{ hide(timerPage); show(landing); };

/* --------- main drill --------- */
startBtn.onclick=()=>{
  audioCtx.resume().then(()=>{

    /* unlock WebSpeech on iOS by immediately speaking a hidden word */
    speakEN('ready');

    const total=parseInt(durEl.value)*1000;
    if(isNaN(total)||total<=0){ alert('Enter a valid time'); return; }

    durEl.disabled=startBtn.disabled=backBtn.disabled=true;
    let c=3;

    const afterCountdown=()=>{
      countEl.textContent='Go!';
      trigger();                        // first signal
      const end=Date.now()+total;
      loop(end);
      setTimeout(()=>{ playTone(250,800,'square');
        durEl.disabled=startBtn.disabled=backBtn.disabled=false;
        countEl.textContent=''; },total);
    };

    const step=()=>{
      if(c>0){ countEl.textContent=c; playTone(); c--; setTimeout(step,1000); }
      else    { afterCountdown(); }
    };

    const loop=(end)=>{
      if(Date.now()<end-400){
        const dly=Math.random()*1500+500;   // 0.5-2 s
        setTimeout(()=>{
          if(Date.now()<end-200){ trigger(); loop(end); }
        },dly);
      }
    };

    const trigger=()=>{
      if(mode==='clap'){ playClap(); return; }

      if(mode==='number'){
        let n; do n=Math.floor(Math.random()*5)+1; while(n===lastVal);
        lastVal=n; speakEN(String(n));
      }
      if(mode==='direction'){
        const dirs=['right','left','back','forward'];
        let d; do d=dirs[Math.floor(Math.random()*dirs.length)]; while(d===lastVal);
        lastVal=d; speakEN(d);
      }
    };

    step();
  });
};
</script>
</body>
</html>
